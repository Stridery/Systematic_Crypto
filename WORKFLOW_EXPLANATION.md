# Strategy Optimization System - Workflow Explanation

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 1. 用户输入参数范围                                       │   │
│  │    - Short MA Min/Max (e.g., 10-15)                      │   │
│  │    - Long MA Min/Max (e.g., 20-25)                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 2. 前端验证 (Validation)                                 │   │
│  │    ✓ Max >= Min  (每个区间)                              │   │
│  │    ✓ Long Min > Short Min                                │   │
│  │    ✓ Long Max > Short Max                                │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 3. 发送POST请求到后端                                     │   │
│  │    POST http://localhost:8000/api/strategy/run           │   │
│  │    Body: {                                                │   │
│  │      "short_min": 10, "short_max": 15,                   │   │
│  │      "long_min": 20, "long_max": 25                       │   │
│  │    }                                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                     后端 API 层 (Backend API)                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 4. API路由: strategy.py                                  │   │
│  │    - 接收HTTP请求                                        │   │
│  │    - 连接数据库                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 5. 从数据库获取BTC价格数据                               │   │
│  │    SELECT timestamp, close FROM price_data               │   │
│  │    WHERE trading_pair = 'BTCUSD'                        │   │
│  │    → 转换为Pandas DataFrame                             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 6. 判断是否需要网格搜索                                  │   │
│  │    if (short_min != short_max) OR (long_min != long_max):│   │
│  │        → 执行网格搜索 (Grid Search)                      │   │
│  │    else:                                                  │   │
│  │        → 单次执行 (Single Run)                            │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│               策略优化模块 (Strategy Optimizer)                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 7. 生成参数组合 (generate_param_combinations)            │   │
│  │    Short: [10, 11, 12, 13, 14, 15]                       │   │
│  │    Long:  [20, 21, 22, 23, 24, 25]                       │   │
│  │    → 生成所有组合，过滤掉 long <= short 的组合           │   │
│  │    → 共 6 × 5 = 30 个有效组合                            │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 8. 遍历每个参数组合                                       │   │
│  │    for each (short, long) combination:                   │   │
│  │        ┌──────────────────────────────────┐             │   │
│  │        │ 8.1 执行策略计算                  │             │   │
│  │        │    calculate_btc_ma_signals()    │             │   │
│  │        │    - 计算短期/长期移动平均线      │             │   │
│  │        │    - 生成交易信号 (1/-1)          │             │   │
│  │        │    - 计算每日收益                  │             │   │
│  │        │    - 计算累计收益曲线              │             │   │
│  │        └──────────────────────────────────┘             │   │
│  │        ┌──────────────────────────────────┐             │   │
│  │        │ 8.2 计算性能指标                  │             │   │
│  │        │    calculate_performance_metrics()│             │   │
│  │        │    - Monthly Return              │             │   │
│  │        │    - Win Rate (%)                │             │   │
│  │        │    - Max Drawdown (%)            │             │   │
│  │        │    - Sharpe Ratio                │             │   │
│  │        │    - Total Trades                │             │   │
│  │        │    - Avg Return (%)             │             │   │
│  │        │    - Volatility (%)              │             │   │
│  │        └──────────────────────────────────┘             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 9. 在Terminal以表格形式输出所有结果                       │   │
│  │    ┌─────────┬─────────┬────────────┬──────────┐       │   │
│  │    │ Short MA│ Long MA │ Monthly Ret│ Win Rate │ ...   │   │
│  │    ├─────────┼─────────┼────────────┼──────────┤       │   │
│  │    │   10    │   20    │   0.5%     │  52.0%   │ ...   │   │
│  │    │   10    │   21    │   0.8%     │  54.0%   │ ...   │   │
│  │    │   ...   │   ...   │   ...      │   ...    │ ...   │   │
│  │    │   15    │   25    │   1.2%     │  58.0%   │ ...   │   │
│  │    └─────────┴─────────┴────────────┴──────────┘       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 10. 选择最佳参数 (基于Monthly Return)                    │   │
│  │     best_result = max(all_results, key=monthly_return)   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 11. 在Terminal打印最佳参数                                │   │
│  │     === Best Parameters Found ===                         │   │
│  │     Short MA: 12                                          │   │
│  │     Long MA: 23                                           │   │
│  │     Monthly Return: 1.2%                                  │   │
│  │     ...                                                    │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                      返回结果到前端                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 12. 构建响应数据                                          │   │
│  │     Response: {                                           │   │
│  │       "status": "success",                                │   │
│  │       "metrics": {                                        │   │
│  │         "monthlyReturn": "1.2%",                          │   │
│  │         "winRate": "58.0%",                               │   │
│  │         ...                                               │   │
│  │       },                                                   │   │
│  │       "best_params": {                                    │   │
│  │         "short_window": 12,                               │   │
│  │         "long_window": 23,                                │   │
│  │         "monthlyReturn": "1.2%"                          │   │
│  │       }                                                    │   │
│  │     }                                                      │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 13. 将最佳参数的Equity Curve存入数据库                   │   │
│  │     INSERT INTO equity_curves                             │   │
│  │     (strategy_key, strategy_name, month, equity)          │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                    前端显示结果                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 14. 更新UI显示                                            │   │
│  │     ┌──────────────────┐                                 │   │
│  │     │ 🏆 Best Params:   │                                 │   │
│  │     │ Short MA: 12     │                                 │   │
│  │     │ Long MA: 23      │                                 │   │
│  │     │ Return: 1.2%     │                                 │   │
│  │     └──────────────────┘                                 │   │
│  │                                                           │   │
│  │     ┌──────────────────┐                                 │   │
│  │     │ Performance:     │                                 │   │
│  │     │ Win Rate: 58%    │                                 │   │
│  │     │ Sharpe: 0.85     │                                 │   │
│  │     │ ...               │                                 │   │
│  │     └──────────────────┘                                 │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 15. Dashboard显示Equity Curve                            │   │
│  │    [绘制最佳参数选择的累计收益曲线]                       │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 详细执行流程

### Phase 1: 前端验证和请求
1. **用户输入**: 在Strategy页面的输入框中输入参数范围
2. **实时验证**: 
   - 检查 `short_max >= short_min`
   - 检查 `long_max >= long_min`
   - 检查 `long_min > short_min`
   - 检查 `long_max > short_max`
3. **发送请求**: 点击"Run"按钮发送POST请求

### Phase 2: 后端API处理
1. **接收请求**: FastAPI路由 `/api/strategy/run` 接收POST请求
2. **数据库连接**: 使用PostgreSQL连接参数
3. **获取数据**: 
   ```sql
   SELECT timestamp, close FROM price_data 
   WHERE trading_pair = 'BTCUSD' 
   ORDER BY timestamp ASC
   ```
4. **转换为DataFrame**: 使用Pandas处理时序数据

### Phase 3: 网格搜索执行（核心逻辑）
1. **判断模式**: 
   - 如果参数范围不同 → Grid Search
   - 如果参数单一 → Single Run
2. **生成组合**: 
   ```python
   for short in range(10, 16):  # [10, 11, 12, 13, 14, 15]
       for long in range(20, 26):  # [20, 21, 22, 23, 24, 25]
           if long > short:
               test_combination(short, long)
   ```
3. **遍历执行**: 
   - 对每个组合调用 `calculate_btc_ma_signals()`
   - 计算移动平均线
   - 生成交易信号
   - 计算收益曲线

### Phase 4: 性能指标计算
对每个参数组合计算7个指标：
1. **Monthly Return**: 年化收益率/12
2. **Win Rate**: 胜率（盈利交易/总交易）
3. **Max Drawdown**: 最大回撤
4. **Sharpe Ratio**: 夏普比率
5. **Total Trades**: 交易次数
6. **Avg Return**: 平均收益率
7. **Volatility**: 收益率波动率

### Phase 5: 结果展示
1. **Terminal表格输出**: 所有参数组合的性能对比表格
2. **选择最佳参数**: 基于Monthly Return最大化的策略
3. **Terminal打印最佳**: 突出显示最优参数组合
4. **存储到数据库**: 保存最佳参数的equity curve数据
5. **返回给前端**: JSON响应包含最佳参数和所有指标

### Phase 6: 前端展示
1. **显示最佳参数**: 绿色高亮显示最佳参数组合
2. **显示性能指标**: 展示所有6个性能指标
3. **更新Equity Curve**: Dashboard上的收益曲线自动更新为最佳参数

## 数据流示例

假设用户输入：
- Short MA: 10-15
- Long MA: 20-25

**生成参数组合** (共30个有效组合):
```
(10, 20), (10, 21), (10, 22), (10, 23), (10, 24), (10, 25),
(11, 20), (11, 21), (11, 22), (11, 23), (11, 24), (11, 25),
...
(15, 20), (15, 21), (15, 22), (15, 23), (15, 24), (15, 25)
```

**Terminal输出**:
```
=== Starting Grid Search: Testing 30 parameter combinations ===
Testing: Short MA=10, Long MA=20
Testing: Short MA=10, Long MA=21
...

==================================================================================
Short MA   Long MA    Monthly Return  Win Rate      Max Drawdown    Sharpe Ratio  ...
==================================================================================
10         20         0.50%          52.00%        15.30%         0.42         ...
10         21         0.65%          54.20%        14.80%         0.48         ...
...
==================================================================================

=== Best Parameters Found ===
Short MA: 12
Long MA: 23
Monthly Return: 1.20%
Win Rate: 58.00%
Sharpe Ratio: 0.85
=============================
```

## 核心优势

1. **自动化参数优化**: 无需手动尝试不同参数组合
2. **系统性探索**: 完整遍历给定范围内的所有有效组合
3. **量化评估**: 基于Monthly Return进行客观选择
4. **可视化对比**: Terminal表格清晰展示所有结果
5. **最佳实践**: 找到历史数据上表现最佳的参数
6. **模块化设计**: 策略执行和参数优化分离

## 技术栈

- **前端**: React, Next.js, TypeScript
- **后端**: FastAPI, Python
- **数据处理**: Pandas, NumPy
- **数据库**: PostgreSQL
- **算法**: 移动平均交叉策略 + 网格搜索优化

